name: Agent Review

on:
  pull_request:
    paths:
      - 'src/**'
      - 'content/**'
      - 'public/**'
      - '.github/workflows/agent-review.yml'

jobs:
  agent-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Start production server
        run: |
          npm run start &
          echo $! > server.pid
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Portfolio Quality Agents
        id: agents
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
        run: |
          npm run agents:run || true
          echo "agents_completed=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Generate dashboard
        if: steps.agents.outputs.agents_completed == 'true'
        run: npm run agents:dashboard

      - name: Upload agent reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-reports-${{ github.run_number }}
          path: |
            reports/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && steps.agents.outputs.agents_completed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reports = [];
            try {
              reports = JSON.parse(
                fs.readFileSync('reports/agent-reports.json', 'utf8')
              );
            } catch (error) {
              console.log('Could not read agent reports');
              return;
            }

            const avgScore = Math.round(
              reports.reduce((sum, r) => sum + r.score, 0) / reports.length
            );

            const scoreEmoji =
              avgScore >= 90 ? 'ðŸŸ¢' :
              avgScore >= 70 ? 'ðŸŸ¡' : 'ðŸ”´';

            const externalReports = reports.filter(r => r.agentType === 'external');
            const internalReports = reports.filter(r => r.agentType === 'internal');

            const comment = `## ${scoreEmoji} Portfolio Quality Agent Review

**Overall Score: ${avgScore}/100**

### ðŸ‘¤ External Validators (User Experience)

${externalReports.map(r =>
              `- **${r.agentName}**: ${r.score}/100`
            ).join('\n') || '_No external agents ran_'}

### ðŸ”§ Internal Validators (Code Quality)

${internalReports.map(r =>
              `- **${r.agentName}**: ${r.score}/100`
            ).join('\n') || '_No internal agents ran_'}

<details>
<summary>ðŸ“Š Detailed Feedback</summary>

${reports.map(r => `
### ${r.agentName} (${r.score}/100)

${r.strengths.length > 0 ? `**âœ… Strengths:**
${r.strengths.slice(0, 5).map(s => `- ${s}`).join('\n')}` : ''}

${r.improvements.length > 0 ? `

**âš ï¸ Improvements:**
${r.improvements.slice(0, 5).map(i => `- ${i}`).join('\n')}` : ''}

${r.violations.length > 0 ? `

**âŒ Violations:**
${r.violations.slice(0, 5).map(v => `- **${v.severity.toUpperCase()}**: ${v.message}`).join('\n')}` : ''}
`).join('\n---\n')}

</details>

---
ðŸ“ˆ [View Dashboard](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) | Generated: ${new Date().toISOString()}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
