name: Weekly Portfolio Health Check

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production
        run: npm run build

      - name: Start server
        run: |
          npm run start &
          echo $! > server.pid
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run comprehensive agent suite
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          FIGMA_ACCESS_TOKEN: ${{ secrets.FIGMA_ACCESS_TOKEN }}
          FIGMA_FILE_KEY: ${{ secrets.FIGMA_FILE_KEY }}
        run: npm run agents:run

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Generate dashboard
        run: npm run agents:dashboard

      - name: Generate trend report
        run: npm run agents:trend || echo "Trend report not available yet"

      - name: Archive reports
        run: |
          mkdir -p archive/$(date +%Y-%m)
          cp -r reports/* archive/$(date +%Y-%m)/report-$(date +%Y-%m-%d).json

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: weekly-health-${{ github.run_number }}
          path: |
            reports/
            archive/
          retention-days: 90

      - name: Create issue if score dropped
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reports = JSON.parse(
              fs.readFileSync('reports/agent-reports.json', 'utf8')
            );

            const avgScore = Math.round(
              reports.reduce((sum, r) => sum + r.score, 0) / reports.length
            );

            // Create issue if below threshold
            if (avgScore < 85) {
              const body = `## ⚠️ Weekly Health Check Alert

Portfolio quality score has dropped below threshold.

**Current Score: ${avgScore}/100**
**Threshold: 85/100**

### Agent Scores:
${reports.map(r => `- ${r.agentName}: ${r.score}/100`).join('\n')}

### Action Items:
${reports
                .filter(r => r.score < 80)
                .map(r => `
**${r.agentName}** needs attention:
${r.improvements.slice(0, 3).map(i => `- ${i}`).join('\n')}
`).join('\n')}

[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Portfolio Health Alert: Score ${avgScore}/100`,
                body: body,
                labels: ['health-check', 'automated']
              });
            }

      - name: Send status notification
        if: always()
        run: |
          echo "Weekly health check completed"
          echo "Check artifacts for detailed reports"
